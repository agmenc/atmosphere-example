<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <script type="text/javascript" src="jquery/jquery-1.6.4.js"></script>
    <script type="text/javascript" src="jquery/jquery.form.js"></script>
    <script type="text/javascript" src="jquery/jquery.atmosphere.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            var connectedEndpoint;
            var callbackAdded = false;
            var detectedTransport = null;

            function subscribe() {
                // jquery.atmosphere.response
                function callback(response) {
                    // Websocket events.
                    $.atmosphere.log('info', ["response.state: " + response.state]);
                    $.atmosphere.log('info', ["response.transport: " + response.transport]);
                    $.atmosphere.log('info', ["response.status: " + response.status]);

                    detectedTransport = response.transport;
                    if (response.transport != 'polling' && response.state == 'messageReceived') {
                        $.atmosphere.log('info', ["response.responseBody: " + response.responseBody]);
                        if (response.status == 200) {
                            var data = response.responseBody;
                            if (data.length > 0) {
                                $('ul').prepend($('<li></li>').text(" Message Received: " + data + " but detected transport is " + detectedTransport));
                            }
                        }
                    }
                }

                var location = '/marketData/subscribe';
                $.atmosphere.subscribe(location,
                        !callbackAdded ? callback : null,
                        $.atmosphere.request = {
                            transport: 'websocket',
                            attachHeadersAsQueryString : true,
                            enableXDR : true
                        });
                connectedEndpoint = $.atmosphere.response;
                callbackAdded = true;
            }

            subscribe();
        });
    </script>
    <style type='text/css'>
        div {
            border: 0 solid black;
        }
    </style>
</head>
<body>
<h1>Subscribe to market data</h1>
<br/>
<h2>Updates</h2>
<ul></ul>
</body>
</html>
